### DigiLocker Verification - Complete Test Flow (Corrected)
### Test all endpoints from user signup to DigiLocker verification

@baseUrl = http://localhost:3000
@contentType = application/json

### ============================================
### STEP 1: SIGNUP - Send OTP to Email
### ============================================
### Send OTP to user's email for registration
### This initiates the signup flow

POST {{baseUrl}}/auth/send-otp
Content-Type: {{contentType}}

{
  "email": "testuser@example.com",
  "username": "testuser123"
}

### Response will include:
### - message: "OTP sent to your email"
### - status: 200
### Note: Check your email or backend console for OTP (usually "123456" in dev)

### ============================================
### STEP 2: VERIFY OTP - Complete Registration
### ============================================
### Verify the OTP sent in STEP 1
### This completes email verification and creates user

POST {{baseUrl}}/auth/verify-otp
Content-Type: {{contentType}}

{
  "email": "testuser@example.com",
  "otp": "123456"
}

### Response will include:
### - userId: "user_id_from_response" (save this!)
### - accessToken: "jwt_token_here" (save this!)
### - refreshToken: "refresh_token_here" (save this!)
### - message: "Email verified successfully"

### ============================================
### STEP 3: SELECT COUNTRY (Optional but recommended)
### ============================================
### Confirm user's country selection

POST {{baseUrl}}/auth/select-country
Content-Type: {{contentType}}
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "country": "India"
}

### ============================================
### STEP 4: DIGILOCKER - Initiate Verification
### ============================================
### Start the DigiLocker verification process
### This generates the consent URL for user to login to DigiLocker

POST {{baseUrl}}/api/digilocker/initiate
Content-Type: {{contentType}}
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "mobileNumber": "9876543210"
}

### Response will include:
### - success: true
### - accountExists: true/false
### - consentUrl: "https://verification-test.cashfree.com/dgl/..." (OPEN THIS URL IN BROWSER!)
### - verificationId: "VER_1702650000000_ABC123" (save this!)
### - flowType: "signin" or "signup"

### ============================================
### STEP 5: USER ACTION - Authenticate in DigiLocker
### ============================================
### IN YOUR BROWSER:
### 1. Open the consentUrl from STEP 4 response
### 2. Login with your Aadhaar/mobile number
### 3. Approve data sharing consent
### 4. You'll be redirected back to your app
### 5. Save the verificationId from STEP 4 for next step

### ============================================
### STEP 6: DIGILOCKER - Process Callback
### ============================================
### After user completes DigiLocker consent, process the callback
### Use the verificationId from STEP 4

POST {{baseUrl}}/api/digilocker/callback
Content-Type: {{contentType}}
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "verificationId": "VER_1702650000000_ABC123"
}

### Response will include:
### - success: true
### - status: "AUTHENTICATED"
### - readyForComparison: true
### - message: "DigiLocker verification successful. Ready for data comparison."

### ============================================
### STEP 7: DIGILOCKER - Get Verification Status (OPTIONAL - for polling)
### ============================================
### Check current verification status anytime
### Useful if you want to poll instead of callback

GET {{baseUrl}}/api/digilocker/status/VER_1702650000000_ABC123
Authorization: Bearer YOUR_ACCESS_TOKEN

### ============================================
### STEP 8: DIGILOCKER - Complete Verification
### ============================================
### Finalize verification by comparing user data with DigiLocker data
### Fields must match data from user's Aadhaar document

POST {{baseUrl}}/api/digilocker/complete
Content-Type: {{contentType}}
Authorization: Bearer YOUR_ACCESS_TOKEN

{
  "verificationId": "VER_1702650000000_ABC123",
  "userProvidedData": {
    "nameAsPerAadhaar": "JOHN DOE",
    "dateOfBirth": "1990-05-15",
    "gender": "Male",
    "country": "India",
    "state": "Maharashtra",
    "district": "Mumbai",
    "pincode": "400001",
    "phoneNumber": "9876543210",
    "addressLine1": "123 Main Street",
    "addressLine2": "Apartment 4B"
  }
}

### Response will include:
### - success: true
### - message: "Identity verification completed successfully"
### - verified: true
### - comparisonDetails with which fields matched

### ============================================
### STEP 9: CHECK USER VERIFICATION STATUS (OPTIONAL)
### ============================================
### Verify that user is now marked as verified

GET {{baseUrl}}/api/digilocker/user-status
Authorization: Bearer YOUR_ACCESS_TOKEN

### Response will include:
### - verified: true
### - verificationType: "DIGILOCKER"

### ============================================
### STEP 10: ADMIN - Cleanup Expired Sessions (OPTIONAL)
### ============================================
### Run this periodically to cleanup old verification sessions (>24 hours)
### Usually run via cron job, not from frontend

POST {{baseUrl}}/api/digilocker/admin/cleanup-expired
Content-Type: {{contentType}}

### ============================================
### STEP 11: HEALTH CHECK
### ============================================
### Verify DigiLocker service is operational

GET {{baseUrl}}/api/digilocker/health

### ============================================
### STEP 12: REFRESH TOKEN (if needed)
### ============================================
### Get a new access token using refresh token
### Use if access token expires during the flow

POST {{baseUrl}}/auth/refresh-token
Content-Type: {{contentType}}

{
  "refreshToken": "YOUR_REFRESH_TOKEN"
}

### ============================================
### ERROR RESPONSE EXAMPLES
### ============================================

### 1. Unauthorized - Missing or invalid token
### HTTP/1.1 401 Unauthorized
### {
###   "success": false,
###   "message": "User authentication required"
### }

### 2. Data Mismatch - User data doesn't match DigiLocker
### HTTP/1.1 400 Bad Request
### {
###   "success": false,
###   "message": "Data mismatch: name does not match"
### }

### 3. Account Already Verified
### HTTP/1.1 409 Conflict
### {
###   "success": false,
###   "message": "This Aadhaar is already registered with another account"
### }

### 4. Invalid Mobile Number
### HTTP/1.1 400 Bad Request
### {
###   "success": false,
###   "message": "Mobile number must be 10 digits"
### }

### ============================================
### QUICK TEST CHECKLIST
### ============================================
### ✓ Step 1: Send OTP and get OTP code
### ✓ Step 2: Verify OTP and save tokens
### ✓ Step 3: Select country (optional)
### ✓ Step 4: Initiate DigiLocker - copy verificationId
### ✓ Step 5: Open consent URL in browser and complete DigiLocker flow
### ✓ Step 6: Call callback with verificationId
### ✓ Step 7: Call complete with user data (MUST match Aadhaar)
### ✓ Step 9: Check user status should show verified
### ✓ All endpoints working!

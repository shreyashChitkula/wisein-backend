// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  REGISTERED
  EMAIL_VERIFIED
  ID_VERIFIED
  VIDEO_VERIFIED
  APPROVED
  ACTIVE
  SUSPENDED
}

enum UserRole {
  INDIVIDUAL
  COMPANY_ADMIN
  ADMIN
}

enum VerificationMethod {
  DIGILOCKER
  STRIPE_IDENTITY
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum SubscriptionPlanType {
  INDIVIDUAL
  COMPANY
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum JobApplicationStatus {
  APPLIED
  SHORTLISTED
  REJECTED
  HIRED
}

enum EngagementType {
  LIKE
  COMMENT
  SHARE
}

enum CallStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  MISSED
  CANCELLED
}

// ============================================
// CORE TABLES
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String?  @unique  // unique username, optional for migration
  passwordHash String?  // nullable for OAuth users
  name      String?
  country   String?
  role      UserRole @default(INDIVIDUAL)
  status    UserStatus @default(REGISTERED)
  
  profilePicUrl  String?
  phoneNumber    String?
  bio            String?
  dateOfBirth    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  verification      UserVerification?
  digiLockerSessions DigiLockerVerificationSession[]
  videoVerification  UserVideoVerification?
  videoVerificationSessions VideoVerificationSession[]
  subscription      Subscription?
  
  // Company
  ownedCompanies    Company[]
  
  // Posts & Engagement
  posts             Post[]
  engagements       Engagement[]
  
  // Jobs
  jobApplications   JobApplication[]
  
  // Calls
  initiatedCalls    Call[] @relation("caller")
  receivedCalls     Call[] @relation("receiver")
  
  // Admin
  adminProfile      Admin?
  
  // OTP verification
  otpVerifications  OtpVerification[]

  @@index([email])
  @@index([status])
  @@index([country])
}

model OtpVerification {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  otp       String
  expiresAt DateTime
  attempts  Int      @default(0)
  isVerified Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserVerification {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  method    VerificationMethod
  idNumber  String?
  
  // DigiLocker specific fields
  digilockerAccountId String? @unique  // Unique ID from DigiLocker
  
  // Identity document data (from DigiLocker or manual entry)
  nameAsPerAadhaar String?
  dateOfBirth      DateTime?
  gender           String?
  country          String?
  state            String?
  district         String?
  pincode          String?
  phoneNumber      String?
  addressLine1     String?
  addressLine2     String?
  
  // Comparison result
  comparisonResult Json?
  
  // Verified data (JSON to support flexibility for different doc types)
  verifiedData Json?
  
  // Video & Frame
  videoUrl  String?
  frameUrl  String?
  
  // Status tracking
  verified           Boolean @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  
  // Rejection reason (if applicable)
  rejectionReason    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  digiLockerSessions DigiLockerVerificationSession[]

  @@index([userId])
  @@index([verificationStatus])
  @@index([digilockerAccountId])
}

// ============================================
// DIGILOCKER VERIFICATION
// ============================================

model DigiLockerVerificationSession {
  id                    String    @id @default(cuid())
  verificationId        String    @unique
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  userVerificationId    String?
  userVerification      UserVerification? @relation(fields: [userVerificationId], references: [id], onDelete: Cascade)
  
  mobileNumber          String
  digilockerAccountId   String?
  
  status                String    // INITIATED, AUTHENTICATED, PENDING, EXPIRED, CONSENT_DENIED
  flowType              String    // signin, signup
  
  consentUrl            String?
  webhookProvidedMobileNo String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@index([verificationId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// VIDEO VERIFICATION
// ============================================

model UserVideoVerification {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session reference
  videoVerificationSessionId String?
  videoVerificationSession   VideoVerificationSession? @relation(fields: [videoVerificationSessionId], references: [id], onDelete: SetNull)
  
  // Video metadata
  videoUrl                String?   // S3 or storage URL
  videoSize              Int?       // in bytes
  videoDuration          Int?       // in seconds
  videoFormat            String?    // mp4, webm, etc.
  
  // Face/Liveness detection
  faceDetected           Boolean    @default(false)
  livenessScore          Float?     // 0.0 to 1.0
  faceMatchScore         Float?     // Comparison with DigiLocker photo
  
  // Verification status
  status                 String     @default("PENDING")  // PENDING, VERIFIED, REJECTED, FAILED
  verified               Boolean    @default(false)
  verifiedAt             DateTime?
  
  // Admin review
  verifiedBy             String?    // Admin user ID who verified
  rejectionReason        String?    // Why verification was rejected
  
  // Comparison with DigiLocker
  comparisonResult       Json?      // Face match details
  
  // Timestamps
  createdAt              DateTime   @default(now())
  updatedAt              DateTime   @updatedAt
  
  // Indexing
  @@index([userId])
  @@index([status])
  @@index([verified])
  @@index([createdAt])
}

model VideoVerificationSession {
  id                    String    @id @default(cuid())
  sessionId             String    @unique  // Generate unique session ID
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session status
  status                String    @default("INITIATED")  // INITIATED, RECORDING, SUBMITTED, PROCESSING, COMPLETED, EXPIRED
  
  // Session data
  recordingUrl          String?
  recordingDuration     Int?
  
  // Server-side recording (if applicable)
  serverSideUrl         String?
  
  // Expiration
  expiresAt             DateTime
  
  // Related verification
  userVideoVerifications UserVideoVerification[]
  
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planType  SubscriptionPlanType
  planName  String   // e.g., "Pro", "Enterprise"
  
  startDate DateTime @default(now())
  endDate   DateTime
  
  status    SubscriptionStatus @default(ACTIVE)
  
  // Cashfree integration
  cashfreeOrderId String?
  cashfreePaymentId String?
  
  // Razorpay integration (optional)
  razorpaySubscriptionId String?
  
  // Auto-renewal
  autoRenew Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company?

  @@index([userId])
  @@index([status])
}

// ============================================
// COMPANY & JOBS
// ============================================

model Company {
  id        String   @id @default(cuid())
  ownerId   String
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  subscriptionId String @unique
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  website     String?
  verified    Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobs      Job[]

  @@index([ownerId])
  @@index([verified])
}

model Job {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  location    String?
  salaryRange String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications JobApplication[]

  @@index([companyId])
}

model JobApplication {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  applicantId String
  applicant   User     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  resumeUrl String?
  status    JobApplicationStatus @default(APPLIED)
  
  appliedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, applicantId])
  @@index([jobId])
  @@index([applicantId])
}

// ============================================
// POSTS & ENGAGEMENTS
// ============================================

model Post {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  content   String
  mediaUrl  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  engagements Engagement[]

  @@index([authorId])
  @@index([createdAt])
}

model Engagement {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      EngagementType
  commentText String?
  
  createdAt DateTime @default(now())

  @@unique([postId, userId, type])
  @@index([postId])
  @@index([userId])
}

// ============================================
// CALLS & AI FEATURES
// ============================================

model Call {
  id        String   @id @default(cuid())
  callerId  String
  caller    User     @relation("caller", fields: [callerId], references: [id], onDelete: Cascade)
  
  receiverId String
  receiver   User     @relation("receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  
  status    CallStatus @default(PENDING)
  
  callDuration Int?  // seconds
  summaryText  String?
  
  startedAt DateTime?
  endedAt   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([callerId])
  @@index([receiverId])
  @@index([status])
}

// ============================================
// ADMIN
// ============================================

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  permissions Json?  // Store admin permissions as JSON
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// TOKENS & SESSIONS
// ============================================

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([expiresAt])
}
